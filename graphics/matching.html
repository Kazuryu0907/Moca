<!DOCTYPE html>
<html>
    <head>
        <title>Moca Matching Overlay</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-green-500" style="background-image: url(1./matching.png);">
        <video src="./gbc.mp4" id="mv_goal" hidden muted></video>
        <div class="flex z-10">
            <div class="mt-5">

                <div class="mt-2 bg-gray-800 w-[350px] h-[50px] rounded-r-[0.2rem]">
                    <div class="ml-5 mr-2">
                        <div class="flex">
                            <div id="player_name0" class=" text-left text-[25px] text-gray-100 font-bold flex-auto">GB</div>
                            <div id="boost0" class="text-right text-[25px] text-gray-100 font-bold w-[50px] flex-initial">100</div>
                        </div>
                        <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                            <div id="boost_bar0" class="bg-orange-500 h-2 rounded-[0.2rem]" style="width:45%"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 bg-gray-800 w-[350px] h-[50px] rounded-r-[0.2rem]">
                    <div class="ml-5 mr-2">
                        <div class="flex">
                            <div id="player_name1" class="text-left text-[25px] text-gray-100 font-bold flex-auto">Kani</div>
                            <div id="boost1" class="text-right text-[25px] text-gray-100 font-bold w-[50px] flex-initial">100</div>
                        </div>
                        <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                            <div id="boost_bar1" class="bg-orange-500 h-2 rounded-[0.2rem]" style="width:45%"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 bg-gray-800 w-[350px] h-[50px] rounded-r-[0.2rem]">
                    <div class="ml-5 mr-2">
                        <div class="flex">
                            <div id="player_name2" class="text-left text-[25px] text-gray-100 font-bold flex-auto">Neko</div>
                            <div id="boost2" class=" text-right text-[25px] text-gray-100 font-bold w-[50px] flex-initial">100</div>
                        </div>
                        <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                            <div id="boost_bar2" class="bg-orange-500 h-2 rounded-[0.2rem]" style="width:45%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Dummy -->
            <div class="flex-auto"></div>
            <div class="mt-10 h-[70px] border  w-[1030px]">
                <!-- <div class="flex-auto"></div> -->
                <div class="flex w-[1030px]">
                    <div class="ml-auto w-[360px] h-[70px]">
                        <div id="blue_team_name" class="fit border  font-bold text-gray-100 text-center text-[50px] mt-auto">GENG</div>
                    </div>
                    <div class="w-[300px] h-[70px] border mt-0">
                        <div class="flex text-center">
                            <div id="score_blue" class="text-center border w-[80px] h-[80px] font-bold text-gray-100 text-[50px]">0</div>
                            <!-- Dummy -->
                            <div class="flex-auto">
                                <div id="time" class="text-[50px] text-center font-bold text-white bottom-0 top-0">
                                    5:00
                                </div>
                            </div>
                            <div id="score_orange" class="text-center border w-[80px] h-[80px] font-bold text-gray-100 text-[50px]">0</div>
                        </div>
                    </div>
                    <div class="mr-auto w-[360px] h-[70px]">
                        <div id="orange_team_name" class="fit border font-bold text-gray-100 text-center text-[50px]">FAZE</div>
                    </div>
                </div>
                <!-- <div class="flex-auto"></div> -->
            </div>
            <!-- Dummy -->
            <div class="flex-auto"></div>
            <div class="mt-5 right-0">

                <div class="mt-2 bg-gray-800 w-[350px] h-[50px] rounded-l-[0.2rem]">
                    <div class="ml-2 mr-5">
                        <div class="flex">
                            <div id="boost3" class="text-left text-[25px] text-gray-100 font-bold w-[50px] flex-initial">100</div>
                            <div id="player_name3" class="text-right text-[25px] text-gray-100 font-bold flex-auto">GB</div>
                        </div>
                        <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                            <div id="boost_bar3" class="bg-blue-500 h-2 rounded-[0.2rem] ml-auto" style="width:45%"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 bg-gray-800 w-[350px] h-[50px] rounded-l-[0.2rem]">
                    <div class="ml-2 mr-5">
                        <div class="flex">
                            <div id="boost4" class="text-left text-[25px] text-gray-100 font-bold w-[50px] flex-initial">100</div>
                            <div id="player_name4" class=" text-right text-[25px] text-gray-100 font-bold flex-auto">Kani</div>
                        </div>
                        <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                            <div id="boost_bar4" class="bg-blue-500 h-2 rounded-[0.2rem] ml-auto" style="width:45%"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 bg-gray-800 w-[350px] h-[50px] rounded-l-[0.2rem]">
                    <div class="ml-2 mr-5">
                        <div class="flex">
                            <div id="boost5" class="text-left text-[25px] text-gray-100 font-bold w-[50px] flex-initial">100</div>
                            <div id="player_name5" class="text-right text-[25px] text-gray-100 font-bold flex-auto">Neko</div>
                        </div>
                        <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                            <div id="boost_bar5" class="bg-blue-500 h-2 rounded-[0.2rem] ml-auto" style="width:45%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="-z-10 absolute bottom-[80px] right-[100px]">
            <div
            class="inline-flex items-center justify-center overflow-hidden rounded-full"
                  >
            <!-- Building a Progress Ring: https://css-tricks.com/building-progress-ring-quickly/ -->
            <svg class="w-[200px] h-[200px] rotate-90">
              <circle
                class="text-gray-300"
                stroke-width="30"
                stroke="currentColor"
                fill="transparent"
                r="100"
                cx="100"
                cy="100"
              />
              <!--
                :stroke-dasharray="circumference"
                :stroke-dashoffset="circumference - percent / 100 * circumference"
               -->
              <circle
                id="inner-circle"
                class="text-blue-600"
                stroke-width="30"
                stroke-dasharray="628"
                stroke-dashoffset="628"
                stroke-linecap="butt"
                stroke="currentColor"
                fill="transparent"
                r="100"
                cx="100"
                cy="100"
              />
            </svg>
            <span id="circle-text" class="absolute text-[80px] font-bold text-blue-700">5</span>
            
                  </div>
        </div>
        <div class="-z-10 absolute bottom-10 ml-5 ">
            <div id="team_name" class="font-bold text-white text-[30px]">
                Glaces Blaze
            </div>
            <div id="abbr" class="font-bold text-white text-[30px]">
                GBC
            </div>
            <div class="flex">
                <div id="player_name" class="font-bold text-white text-[50px]">
                    Moca
                </div>
                <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                    <p>score</p>
                    <p id="score">0</p>
                </div>
                <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                    <p>goals</p>
                    <p id="goals">0</p>
                </div>
                <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                    <p>shots</p>
                    <p id="shots">0</p>
                </div>
                <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                    <p>assists</p>
                    <p id="assists">0</p>
                </div>
                <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                    <p>saves</p>
                    <p id="saves">0</p>
                </div>
            </div>
        </div>




        <!-- <button onclick="feedout('#blue_1',-500);feedout('#blue_2',-500);feedout('#orange_1',500);feedout('#orange_2',500);">B</button> -->
        <!-- <button id="b">C</button> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.0/gsap.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script>
            const fit = () => {
                const defaultTextSize = 50;
                const divHeight = 70;
                let resizeText = document.getElementsByClassName('fit');
                for (let i = 0; i < resizeText.length; i++) {
                    let textElm = resizeText[i];
                    //----------INIT---------
                    textElm.style.marginTop = "0px";
                    textElm.style.fontSize = `${defaultTextSize}px`;
                    // console.log(i,textElm.getBoundingClientRect().height,textElm.scrollHeight);
                    let size = defaultTextSize;
                    for(;textElm.scrollHeight > divHeight && size > 1;size--){
                        textElm.style.fontSize = size + "px";
                    }
                    const margin = (divHeight - textElm.scrollHeight)/2;
                    textElm.style.marginTop = `${margin}px`;
                }
            }
            const sleep = (second) => new Promise(resolve => setTimeout(resolve, second * 1000));
            const circle = async() => {
                const r = 100;
                let circumference = 2 * r * Math.PI;
                let per = 0;
                for(let i = 0;i<100;i++){
                    per += 0.75;
                    let offset = ((100.-per)/100) * circumference;
                    $("#inner-circle").attr("stroke-dashoffset",Math.floor(offset));
                    $("#inner-circle").attr("stroke-dasharray",circumference);
                    $("#circle-text").text(`${Math.floor(i+1)}`);
                    await sleep(0.01);
                }
            }

            const setBoost = (per) => {
                const r = 100;
                let circumference = 2 * r * Math.PI;
                //Max75%
                let offset = ((100.-per*0.75)/100) * circumference;
                $("#inner-circle").attr("stroke-dashoffset",Math.floor(offset));
                $("#inner-circle").attr("stroke-dasharray",circumference);
                $("#circle-text").text(`${Math.floor(per)}`);
            }

            const feedin = (tar,x) => {
                gsap.set(tar,{opacity:1});
                gsap.from(tar,{x:x,duration:0.8,opacity:0,ease:Circ.easeOut});
            }

            const feedout = (tar,x)=> {
                gsap.set(tar,{opacity:0});
                gsap.to(tar,{x:x,duration:0.8,opacity:1,ease:Circ.easeOut});
            };

            const playTransition = (id) => {
                $(id).show();
                const v = $(id).get(0);
                v.play();
                $(id).on("ended",function(){
                    $(this).hide();
                });
            }

            let webSocket;
            let playerTable = {};
            let idTable = {};
            let matchInfo = {};
            let teamData = [];
            //右下のBoostゲージ Index
            let watchingBoostIndex = null;
            webSocket = new WebSocket("ws://localhost:8001/boost");

            webSocket.onmessage = function(message){
                
                const msg = JSON.parse(message.data);
                const cmd = msg["cmd"];
                const data = msg["data"];
                if(cmd != "boost" || cmd != "time")console.log(msg);
                if(cmd == "boost"){// Boost
                    // document.getElementById("boosts").style.visibility = "visible";
                    const {boost,index} = data;
                    if(index == watchingBoostIndex)setBoost(Number(boost));
                    document.getElementById("boost"+index).textContent = boost;
                    document.getElementById("boost_bar"+index).style.width = boost+"%";
                }
                else if(cmd == "player"){
                    const {playerIndex,playerName,team} = data;
                    console.log(playerIndex);
                    watchingBoostIndex = playerIndex;
                    const watchingPlayerId = playerTable[playerIndex];
                    const spreadPlayerName = idTable[watchingPlayerId];
                    document.getElementById("player_name").textContent = spreadPlayerName;
                    const boost = document.getElementById("boost"+playerIndex).textContent;
                    setBoost(Number(boost));
                    const teamName = matchInfo[team];
                    const teamOb = teamData.find(t => t.teamName == teamName);
                    const teamAbbr = teamOb.teamAbbrevitation;
                    const boostColor = team == "blue" ? "text-blue-600" : "text-orange-600";
                    const boostTextColor = team == "blue" ? "text-blue-700" : "text-orange-700";
                    $("#abbr").text(teamAbbr);
                    $("#team_name").text(teamName);

                    //Change Boost Color
                    let circleElm = document.getElementById("inner-circle");
                    circleElm.classList.remove("text-blue-600");circleElm.classList.remove("text-orange-600");
                    circleElm.classList.add(boostColor);
                    let textElm = document.getElementById("circle-text");
                    textElm.classList.remove("text-blue-700");textElm.classList.remove("text-orange-700");
                    textElm.classList.add(boostTextColor);
                }
                else if(cmd == "score"){
                    const {score} = data;
                    document.getElementById("score").textContent = score;
                }
                else if(cmd == "subScore"){
                    const {goals,shots,assists,saves} = data;
                    document.getElementById("goals").textContent = goals;
                    document.getElementById("shots").textContent = shots;
                    document.getElementById("assists").textContent = assists;
                    document.getElementById("saves").textContent = saves;
                }
                else if(cmd == "matchInfo"){
                    matchInfo = data;
                    const blueTeamName = data.blue;
                    const orangeTeamName = data.orange;
                    document.getElementById("blue_team_name").textContent = blueTeamName;
                    document.getElementById("orange_team_name").textContent = orangeTeamName;
                    fit();
                }
                else if(cmd == "playerTable"){// teamTable
                    const ids = data;
                    console.log(ids,idTable);
                    playerTable = {...ids};
                    for(let i = 0;i<6;i++){
                        const id = ids[i];
                        document.getElementById("player_name"+i).textContent = idTable[id];
                    }
                }
                else if(cmd == "time"){
                    const time = data;
                    const minutes = Math.floor(time/60);
                    const seconds = time % 60;
                    document.getElementById("time").textContent = `${minutes}:${seconds < 10 ? "0"+seconds : seconds}`; 
                }
                else if(cmd == "goals"){//onGoal
                    //    string,string,blue|orange
                    const {assistId,scoreId,team} = data;
                    const currentScore = Number(document.getElementById(`score_${team}`).textContent);
                    document.getElementById(`score_${team}`).textContent = currentScore + 1;
                    setTimeout(() => {playTransition("#mv_goal")},3000);
                }
                else if(cmd == "endReplay"){
                    playTransition("#mv_goal");
                }
                //RESET
                else if(cmd == "endStats"){
                    $("#score_blue").text("0");
                    $("#score_orange").text("0");
                    $("#time").text("5:00");
                }
                else if(cmd == "teamData"){
                    teamData = data;
                }
                else if(cmd == "idTable"){
                    idTable = data;
                }
            }

        </script>
    </body>
</html>