<!DOCTYPE html>
<html>
    <head>
        <title>Moca Matching Overlay</title>
        <meta charset="utf-8">
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-green-500" style="background-color: rgba(0, 0, 0, 1);">
        <video src="./gbc.mp4" id="mv_goal" hidden muted></video>
        <img id="dummy_img" hidden src="" alt="">
        <div class="flex z-10">
            <div class="mt-5">
                <div id="player_0" class="mt-2 w-[350px] h-[150px] rounded-r-[0.2rem]">
                    <div class="ml-5 player_frame_blue">
                        <div class="flex">
                            <img id="player_icon0" src="./kafka.png" class="w-[150px] rounded-lg" alt="">
                            <div class="ml-2 mr-2 w-full relative">
                                <div class="w-full absolute bottom-2">
                                    <div id="player_name0" class="text-left text-[25px] text-gray-100 font-bold flex-auto" style="word-break: break-all;">Uni</div>
                                    <div class="mt-1 w-full bg-black h-2 rounded-[0.2rem]">
                                        <div id="boost_bar0" class="bg-orange-500 h-2 rounded-[0.2rem]" style="width:33%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="player_1" class="mt-2 w-[350px] h-[150px] rounded-r-[0.2rem]">
                    <div class="ml-5 player_frame_blue">
                        <div class="flex">
                            <img id="player_icon1" src="./kafka.png" class="w-[150px] rounded-lg" alt="">
                            <div class="ml-2 mr-2 w-full relative">
                                <div class="w-full absolute bottom-2">
                                    <div id="player_name1" class="text-left text-[25px] text-gray-100 font-bold flex-auto" style="word-break: break-all;">Kani</div>
                                    <div class="mt-1 w-full bg-black h-2 rounded-[0.2rem]">
                                        <div id="boost_bar1" class="bg-orange-500 h-2 rounded-[0.2rem]" style="width:33%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="player_2" class="mt-2 w-[350px] h-[150px] rounded-r-[0.2rem]">
                    <div class="ml-5 player_frame_blue">
                        <div class="flex">
                            <img id="player_icon2" src="./kafka.png" class="w-[150px] rounded-lg" alt="">
                            <div class="ml-2 mr-2 w-full relative">
                                <div class="w-full absolute bottom-2">
                                    <div id="player_name2" class="text-left text-[25px] text-gray-100 font-bold flex-auto" style="word-break: break-all;">天ノ川寝夢</div>
                                    <div class="mt-1 w-full bg-black h-2 rounded-[0.2rem]">
                                        <div id="boost_bar2" class="bg-orange-500 h-2 rounded-[0.2rem]" style="width:33%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Dummy -->
            <div class="flex-auto"></div>
            <div class="mt-10 h-[70px]  w-[1030px]">
                <!-- <div class="flex-auto"></div> -->
                <div class="flex w-[1030px]">
                    <div class="ml-auto w-[360px] h-[70px]">
                        <div class="teamName teamName_blue fit  font-bold text-gray-100 text-center text-[50px] mt-auto"><span  id="blue_team_name">GENG</span></div>
                    </div>
                    <div class="w-[300px] h-[70px] mt-0">
                        <div class="flex text-center">
                            <div id="score_blue" class="text-center w-[80px] h-[80px] font-bold text-gray-100 text-[50px]">0</div>
                            <!-- Dummy -->
                            <div class="flex-auto">
                                <div id="time" class="text-[50px] text-center font-bold text-white bottom-0 top-0">
                                    5:00
                                </div>
                            </div>
                            <div id="score_orange" class="text-center w-[80px] h-[80px] font-bold text-gray-100 text-[50px]">0</div>
                        </div>
                    </div>
                    <div class="mr-auto w-[360px] h-[70px]">
                        <div class="teamName teamName_orange fit font-bold text-gray-100 text-center text-[50px]"><span id="orange_team_name">FAZE</span></div>
                    </div>
                </div>
                <!-- <div class="flex-auto"></div> -->
            </div>
            <!-- Dummy -->
            <div class="flex-auto"></div>
            <div class="mt-5 right-0">

                <div id="player_3" class="mt-2 w-[350px] h-[150px] rounded-r-[0.2rem]">
                    <div class="mr-5 player_frame_orange">
                        <div class="flex flex-row-reverse">
                            <img id="player_icon3" src="./kafka.png" class="w-[150px] rounded-lg" alt="">
                            <div class="ml-2 mr-2 w-full relative">
                                <div class="w-full absolute bottom-2">
                                    <div id="player_name3" class="text-right text-[25px] text-gray-100 font-bold flex-auto" style="word-break: break-all;">Inu</div>
                                    <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                                        <div id="boost_bar3" class="bg-blue-500 h-2 rounded-[0.2rem] ml-auto" style="width:33%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="player_4" class="mt-2 w-[350px] h-[150px] rounded-l-[0.2rem]">
                    <div class="mr-5 player_frame_orange">
                        <div class="flex flex-row-reverse">
                            <img id="player_icon4" src="./kafka.png" class="w-[150px] rounded-lg" alt="">
                            <div class="ml-2 mr-2 w-full relative">
                                <div class="w-full absolute bottom-2">
                                    <div id="player_name4" class="text-right text-[25px] text-gray-100 font-bold flex-auto" style="word-break: break-all;">Kaniiiiiiiiii</div>
                                    <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                                        <div id="boost_bar4" class="bg-blue-500 h-2 rounded-[0.2rem] ml-auto" style="width:33%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="player_5" class="mt-2 w-[350px] h-[150px] rounded-l-[0.2rem]">
                    <div class="mr-5 player_frame_orange">
                        <div class="flex flex-row-reverse">
                            <img id="player_icon5" src="./kafka.png" class="w-[150px] rounded-lg" alt="">
                            <div class="ml-2 mr-2 w-full relative">
                                <div class="w-full absolute bottom-2">
                                    <div id="player_name5" class="text-right text-[25px] text-gray-100 font-bold flex-auto" style="word-break: break-all;">Wani</div>
                                    <div class="w-auto bg-black h-2 rounded-[0.2rem]">
                                        <div id="boost_bar5" class="bg-blue-500 h-2 rounded-[0.2rem] ml-auto" style="width:33%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="boost_gauge" class="-z-10 absolute bottom-[80px] right-[100px]">
            <div
            class="inline-flex items-center justify-center overflow-hidden rounded-full"
                  >
            <!-- Building a Progress Ring: https://css-tricks.com/building-progress-ring-quickly/ -->
            <svg class="w-[200px] h-[200px] rotate-90">
              <circle
                class="text-gray-300"
                stroke-width="30"
                stroke="currentColor"
                fill="transparent"
                r="100"
                cx="100"
                cy="100"
              />
              <!--
                :stroke-dasharray="circumference"
                :stroke-dashoffset="circumference - percent / 100 * circumference"
               -->
              <circle
                id="inner-circle"
                class="text-blue-600"
                stroke-width="30"
                stroke-dasharray="628"
                stroke-dashoffset="628"
                stroke-linecap="butt"
                stroke="currentColor"
                fill="transparent"
                r="100"
                cx="100"
                cy="100"
              />
            </svg>
            <span id="circle-text" class="absolute text-[80px] font-bold text-blue-700">5</span>
            
        </div>
        </div>
        <img src="" id="player_icon" class="-z-10 absolute bottom-0  ml-2 w-[500px] h-[600px] object-cover object-left-top" alt="">
        <div id="sub_stats" class="-z-10 absolute bottom-10 ml-7 ">
            <div class="">
                <div id="team_name" class="font-bold text-white text-[30px]">
                    Glaces Blaze
                </div>
                <div id="abbr" class="font-bold text-white text-[30px]">
                    GBC
                </div>
                <div class="flex">
                    <div class="font-bold text-white text-[50px] w-[270px] flex">
                        <span id="player_name" class="my-auto">天ノ川寝夢</span>
                    </div>
                    <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                        <p>score</p>
                        <p id="score">0</p>
                    </div>
                    <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                        <p>goals</p>
                        <p id="goals">0</p>
                    </div>
                    <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                        <p>shots</p>
                        <p id="shots">0</p>
                    </div>
                    <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                        <p>assists</p>
                        <p id="assists">0</p>
                    </div>
                    <div class="text-center font-bold text-white text-[30px] mx-[30px] my-auto">
                        <p>saves</p>
                        <p id="saves">0</p>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.0/gsap.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script>
            const opa0 = (tar) => {
                gsap.set(tar,{opacity:0});
            }

            const feedin = (tar,diffx,diffy,duration=2) => {
                gsap.set(tar,{opacity:1});
                if(diffx == null)gsap.from(tar,{y:diffy,duration:duration,opacity:0,ease:"expo.out"});
                else gsap.from(tar,{x:diffx,duration:duration,opacity:0,ease:"expo.out"});
            }

            const sleep = ms => new Promise(resolve => setTimeout(resolve,ms));
            const feedinFromTop = async() => {
                ["#time"].forEach(tar => feedin(tar,null,-100,1));
                // await sleep(1000);
                ["#score_blue","#score_orange"].forEach(tar => feedin(tar,null,-100,1));
                await sleep(1000);
                ["#blue_team_name","#orange_team_name"].forEach(tar => feedin(tar,null,-500,1.5));
            }
            const feedinPlayers = async() => {
                ["#player_0","#player_3"].forEach((tar,i) => feedin(tar,-1*((i+1)%2-0.5)*2*100,null,1));
                await sleep(300);
                ["#player_1","#player_4"].forEach((tar,i) => feedin(tar,-1*((i+1)%2-0.5)*2*100,null,1));
                await sleep(300);
                ["#player_2","#player_5"].forEach((tar,i) => feedin(tar,-1*((i+1)%2-0.5)*2*100,null,1));
            } 
            const feedinSubStats = async() => {
                feedin("#sub_stats",null,100);
                feedin("#boost_gauge",null,100);
            }
            const feedinit = async() => {
                // await feedinFromTop();
                gsap.to("#blue_team_name",{opacity:1});gsap.to("#orange_team_name",{opacity:1});
                $(".teamName").addClass("fade");
                await sleep(3000);
                await feedinPlayers();
                await sleep(1000);
                await feedinSubStats();

            }
            window.onload = () => {
                // const feedFromTopList = ["#blue_team_name","#orange_team_name","#time","#score_blue","#score_orange"];
                const playerList = [...Array(6).keys()].map(i => `#player_${i}`);
                const subStatsList = ["#sub_stats","#boost_gauge","#player_icon"];
                // feedFromTopList.forEach((tar) => opa0(tar));
                playerList.forEach(tar => opa0(tar));
                subStatsList.forEach(tar => opa0(tar));
                $(".team_name").addClass("fade");

                const boost = 33;
                setBoost(Number(boost));
                gsap.delayedCall(1,feedinit);
            }

            const fit = () => {
                const defaultTextSize = 50;
                const divHeight = 70;
                let resizeText = document.getElementsByClassName('fit');
                for (let i = 0; i < resizeText.length; i++) {
                    let textElm = resizeText[i];
                    //----------INIT---------
                    textElm.style.marginTop = "0px";
                    textElm.style.fontSize = `${defaultTextSize}px`;
                    // console.log(i,textElm.getBoundingClientRect().height,textElm.scrollHeight);
                    let size = defaultTextSize;
                    for(;textElm.scrollHeight > divHeight && size > 1;size--){
                        textElm.style.fontSize = size + "px";
                    }
                    const margin = (divHeight - textElm.scrollHeight)/2;
                    textElm.style.marginTop = `${margin}px`;
                }
            }
            const circle = async() => {
                const r = 100;
                let circumference = 2 * r * Math.PI;
                let per = 0;
                for(let i = 0;i<100;i++){
                    per += 0.75;
                    let offset = ((100.-per)/100) * circumference;
                    $("#inner-circle").attr("stroke-dashoffset",Math.floor(offset));
                    $("#inner-circle").attr("stroke-dasharray",circumference);
                    $("#circle-text").text(`${Math.floor(i+1)}`);
                    await sleep(10);
                }
            }

            const setBoost = (per) => {
                const r = 100;
                let circumference = 2 * r * Math.PI;
                //Max75%
                let offset = ((100.-per*0.75)/100) * circumference;
                $("#inner-circle").attr("stroke-dashoffset",Math.floor(offset));
                $("#inner-circle").attr("stroke-dasharray",circumference);
                $("#circle-text").text(`${Math.floor(per)}`);
            }


            const playTransition = (id) => {
                $(id).show();
                const v = $(id).get(0);
                v.play();
                $(id).on("ended",function(){
                    $(this).hide();
                });
            }

            let webSocket;
            let playerTable = {};
            let idTable = {};
            let matchInfo = {};
            let teamData = [];
            let imgPath = "";
            //右下のBoostゲージ Index
            let watchingBoostIndex = null;
            webSocket = new WebSocket("ws://localhost:8001/boost");

            webSocket.onmessage = function(message){
                
                const msg = JSON.parse(message.data);
                const cmd = msg["cmd"];
                const data = msg["data"];
                if(cmd != "boost" || cmd != "time")console.log(msg);
                if(cmd == "imgPath"){
                    imgPath = data;
                }
                else if(cmd == "boost"){// Boost
                    // document.getElementById("boosts").style.visibility = "visible";
                    const {boost,index} = data;
                    if(index == watchingBoostIndex)setBoost(Number(boost));
                    document.getElementById("boost"+index).textContent = boost;
                    document.getElementById("boost_bar"+index).style.width = boost+"%";
                }
                else if(cmd == "player"){
                    const {playerIndex,playerName,team} = data;
                    console.log(playerIndex);
                    watchingBoostIndex = playerIndex;
                    const watchingPlayerId = playerTable[playerIndex];
                    const spreadPlayerName = idTable[watchingPlayerId];
                    document.getElementById("player_name").textContent = spreadPlayerName;
                    const boost = document.getElementById("boost"+playerIndex).textContent;
                    setBoost(Number(boost));
                    const teamName = matchInfo[team];
                    const teamOb = teamData.find(t => t.teamName == teamName);
                    const teamAbbr = teamOb.teamAbbrevitation;
                    const boostColor = team == "blue" ? "text-blue-600" : "text-orange-600";
                    const boostTextColor = team == "blue" ? "text-blue-700" : "text-orange-700";
                    $("#abbr").text(teamAbbr);
                    $("#team_name").text(teamName);

                    //Icon
                    const path = window.obsstudio != undefined ? `http://absolute/${imgPath}/icons/` : `${imgPath}/icons/`;
                    $("#player_icon").attr("src",path+`${spreadPlayerName}.png`);
                    gsap.to("#player_icon",{opacity:1});
                    //Change Boost Color
                    let circleElm = document.getElementById("inner-circle");
                    circleElm.classList.remove("text-blue-600");circleElm.classList.remove("text-orange-600");
                    circleElm.classList.add(boostColor);
                    let textElm = document.getElementById("circle-text");
                    textElm.classList.remove("text-blue-700");textElm.classList.remove("text-orange-700");
                    textElm.classList.add(boostTextColor);
                }
                else if(cmd == "score"){
                    const {score} = data;
                    document.getElementById("score").textContent = score;
                }
                else if(cmd == "subScore"){
                    const {goals,shots,assists,saves} = data;
                    document.getElementById("goals").textContent = goals;
                    document.getElementById("shots").textContent = shots;
                    document.getElementById("assists").textContent = assists;
                    document.getElementById("saves").textContent = saves;
                }
                else if(cmd == "matchInfo"){
                    matchInfo = data;
                    const blueTeamName = data.blue;
                    const orangeTeamName = data.orange;
                    document.getElementById("blue_team_name").textContent = blueTeamName;
                    document.getElementById("orange_team_name").textContent = orangeTeamName;
                    fit();
                    // V用立ち絵のpreLoad
                    const blueTeamMembers = teamData.find(t => t.teamName == blueTeamName).playerNames;
                    const orangeTeamMembers = teamData.find(t => t.teamName == orangeTeamName).playerNames;
                    console.log(blueTeamMembers,orangeTeamMembers);
                    const path = window.obsstudio != undefined ? `http://absolute/${imgPath}/icons/` : `${imgPath}/icons/`;
                    blueTeamMembers.forEach((name,i) => {
                        $(`#player_icon${i}`).attr("src",path+`${name}.png`);
                        // $(`#player_name${i}`).text(name);
                    });
                    orangeTeamMembers.forEach((name,i) => {
                        $(`#player_icon${i+3}`).attr("src",path+`${name}.png`);
                        // $(`#player_name${i+3}`).text(name);
                    });
                }
                // ? ここバグってそう
                else if(cmd == "playerTable"){// teamTable
                    const ids = data;
                    console.log(ids,idTable);
                    playerTable = {...ids};
                    for(let i = 0;i<6;i++){
                        const id = ids[i];
                        // document.getElementById("player_name"+i).textContent = idTable[id];
                    }
                }
                else if(cmd == "time"){
                    const time = data;
                    const minutes = Math.floor(time/60);
                    const seconds = time % 60;
                    document.getElementById("time").textContent = `${minutes}:${seconds < 10 ? "0"+seconds : seconds}`; 
                }
                else if(cmd == "goals"){//onGoal
                    //    string,string,blue|orange
                    const {assistId,scoreId,team} = data;
                    const currentScore = Number(document.getElementById(`score_${team}`).textContent);
                    document.getElementById(`score_${team}`).textContent = currentScore + 1;
                    setTimeout(() => {playTransition("#mv_goal")},3000);
                }
                else if(cmd == "endReplay"){
                    playTransition("#mv_goal");
                }
                //RESET
                else if(cmd == "endStats"){
                    $("#score_blue").text("0");
                    $("#score_orange").text("0");
                    $("#time").text("5:00");
                }
                else if(cmd == "teamData"){
                    teamData = data;
                }
                else if(cmd == "idTable"){
                    idTable = data;
                }
            }

        </script>
        <style>
            .player_frame_blue{
                background-image: url('data:image/svg+xml;utf8,<svg width="330" height="150" viewBox="0 0 330 150" xmlns="http://www.w3.org/2000/svg"><path d="M0.5 10C0.5 4.75329 4.7533 0.5 10 0.5H140C145.247 0.5 149.5 4.7533 149.5 10V74C149.5 79.799 154.201 84.5 160 84.5H320C325.247 84.5 329.5 88.7533 329.5 94V140C329.5 145.247 325.247 149.5 320 149.5H150H10C4.75329 149.5 0.5 145.247 0.5 140V10Z" fill="rgb(31,41,58)" stroke="rgb(31,41,58)"/></svg>');
            }
            .player_frame_orange{
                background-image: url('data:image/svg+xml;utf8,<svg width="330" height="150" viewBox="0 0 330 150" xmlns="http://www.w3.org/2000/svg"><path fill="rgb(31,41,58)" fill-rule="evenodd" clip-rule="evenodd" d="M180 10C180 4.47715 184.477 0 190 0H320C325.523 0 330 4.47715 330 10V140C330 145.523 325.523 150 320 150H180H10C4.47716 150 0 145.523 0 140V94C0 88.4771 4.47715 84 10 84H170C175.523 84 180 79.5229 180 74V10Z"/><path d="M190 -1C183.925 -1 179 3.92487 179 10H181C181 5.02944 185.029 1 190 1V-1ZM320 -1H190V1H320V-1ZM331 10C331 3.92487 326.075 -1 320 -1V1C324.971 1 329 5.02944 329 10H331ZM331 140V10H329V140H331ZM320 151C326.075 151 331 146.075 331 140H329C329 144.971 324.971 149 320 149V151ZM180 151H320V149H180V151ZM10 151H180V149H10V151ZM-1 140C-1 146.075 3.92487 151 10 151V149C5.02944 149 1 144.971 1 140H-1ZM-1 94V140H1V94H-1ZM10 83C3.92487 83 -1 87.9249 -1 94H1C1 89.0294 5.02944 85 10 85V83ZM170 83H10V85H170V83ZM170 85C176.075 85 181 80.0751 181 74H179C179 78.9706 174.971 83 170 83V85ZM179 10V74H181V10H179Z" fill="rgb(31,41,58)"/></svg>');
            }
            .teamName_blue{
                overflow: hidden;
                transform: translate(100%,0);
                transition: transform cubic-bezier(0.215, 0.61, 0.355, 1) 0s;
            }
            .teamName_blue span{
                display: block;
                transform: translate(-100%,0);
                transition: transform cubic-bezier(0.215, 0.61, 0.355, 1) 0s;
            }
            .teamName_orange{
                overflow: hidden;
                transform: translate(-100%,0);
                transition: transform cubic-bezier(0.215, 0.61, 0.355, 1) 0s;
            }
            .teamName_orange span{
                display: block;
                transform: translate(100%,0);
                transition: transform cubic-bezier(0.215, 0.61, 0.355, 1) 0s;
            }
            .teamName.fade,
            .teamName.fade span{
                transform: translate(0,0);
                transition: transform cubic-bezier(0.215, 0.61, 0.355, 1) 1s;
            }
        </style>
    </body>
</html>