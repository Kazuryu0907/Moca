<!DOCTYPE html>
<html lang="jp">
    <head>
        <meta charset="UTF-8">
        <script src="https://cdn.tailwindcss.com"></script>
        <style type="text/tailwindcss">
            @layer utilities{
                .player-name{
                    @apply text-gray-100 font-bold text-[50px] mt-1 text-center;
                }
                .player-icon{
                    @apply w-[280px] h-[280px] object-cover object-top border rounded-2xl;
                }
                .w-team{
                    @apply w-[900px];
                }
            }
        </style>
    </head>
    <body class="bg-gray-700 ">
        <div class="relative w-full h-[200px] ">
            <div id="bo" class="absolute font-bold text-gray-100 text-[50px] text-center inset-0 top-[50px]">bo3</div>
            <div id="matchName" class="absolute font-bold text-gray-100 text-[100px] text-center inset-0 top-[100px]">Grand Final</div>
        </div>
        <div class="font-bold  text-gray-100 text-[100px] flex mt-[150px] mx-10">
            <div id="blueTeamName" class="grid place-items-center h-[150px] fit w-team text-center my-auto">地上戦隊アカレンジャイ∠(　˙-˙ )／</div>
            <div class="flex-auto"></div>
            <div id="orangeTeamName" class="grid place-items-center h-[150px] fit  w-team text-center my-auto">総プレイ40時間</div>
        </div>
        <div class="mt-[80px] mx-7">
            <div class="flex">
                <!-- 900px -->
                <div class="flex gap-[30px] ">
                    <div id="vtuber_b1">
                        <img id="img_b1" class="player-icon">
                        <div id="player_b1" class="player-name">宮古ミヤ</div>
                    </div>
                    <div id="vtuber_b2">
                        <img id="img_b2" class="player-icon">
                        <div id="player_b2" class="player-name">幽鬼シオン</div>
                    </div>
                    <div id="vtuber_b3">
                        <img id="img_b3" class="player-icon">
                        <div id="player_b3" class="player-name">早波八雲</div>
                    </div>
                </div>
                <div class="flex-auto"></div>
                <div class="flex gap-[30px]">
                    <div id="vtuber_o1">
                        <img id="img_o1" class="player-icon">
                        <div id="player_o1" class="player-name">鳴海小波音</div>
                    </div>
                    <div id="vtuber_o2">
                        <img id="img_o2" class="player-icon">
                        <div id="player_o2" class="player-name">ちゃんひな</div>
                    </div>
                    <div id="vtuber_o3">
                        <img id="img_o3" class="player-icon">
                        <div id="player_o3" class="player-name">石蕗なのは</div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.0/gsap.min.js"></script>
        <script type="text/javascript">
            let webSocket = new WebSocket("ws://localhost:8001/nextMatch");
            let imgPath = "";
            let teamData = [];
            webSocket.onmessage = function(message){
                const msg = JSON.parse(message.data);
                const {cmd,data} = msg;
                console.log(msg);
                if(cmd == "imgPath"){
                    imgPath = data;
                }
                if(cmd == "teamData"){
                    teamData = data;
                }
                if(cmd == "matchInfo"){
                    const blueTeamName = data.blue;
                    const orangeTeamName = data.orange;
                    const matchName = data.name;
                    const bo = data.bo;
                    const blueMembers = teamData.find(t => t.teamName == blueTeamName).playerNames;
                    const orangeMembers = teamData.find(t => t.teamName == orangeTeamName).playerNames;;
                    document.getElementById("blueTeamName").textContent = blueTeamName;
                    document.getElementById("orangeTeamName").textContent = orangeTeamName;
                    document.getElementById("bo").textContent = bo;
                    document.getElementById("matchName").textContent = matchName;
                    fit();
                    const path = window.obsstudio != undefined ? `http://absolute/${imgPath}/icons/` : `${imgPath}/icons/`;
                    for(let i = 0;i<3;i++){
                        //Blue
                        $(`#player_b${i+1}`).text(blueMembers[i]);
                        $(`#img_b${i+1}`).attr("src",path+`${blueMembers[i]}.png`);
                        //Orange
                        $(`#player_o${i+1}`).text(orangeMembers[i]);
                        $(`#img_o${i+1}`).attr("src",path+`${orangeMembers[i]}.png`);
                    }
                }
            }

            const fit = () => {
                const defaultTextSize = 150;
                const divHeight = 150;
                let resizeText = document.getElementsByClassName('fit');
                for (let i = 0; i < resizeText.length; i++) {
                    let textElm = resizeText[i];
                    //----------INIT---------
                    textElm.style.marginTop = "0px";
                    textElm.style.fontSize = `${defaultTextSize}px`;
                    // console.log(i,textElm.getBoundingClientRect().height,textElm.scrollHeight);
                    let size = defaultTextSize;
                    for(;textElm.scrollHeight > divHeight && size > 1;size--){
                        textElm.style.fontSize = size + "px";
                    }
                    const margin = (divHeight - textElm.scrollHeight)/2;
                    textElm.style.marginTop = `${margin}px`;
                }
            }

            const opa0 = (tar) => {
                gsap.set(tar,{opacity:0});
            }

            const feedin = (tar,diffx,diffy,duration=2) => {
                gsap.set(tar,{opacity:1});
                if(diffx == null)gsap.from(tar,{y:diffy,duration:duration,opacity:0,ease:Circ.easeOut});
                else gsap.from(tar,{x:diffx,duration:duration,opacity:0,ease:Circ.easeOut});
            }

            const feedout = (tar,x)=> {
                opa0(tar);
                gsap.to(tar,{x:x,duration:0.8,opacity:1,ease:Circ.easeOut});
            };

            const sleep = ms => new Promise(resolve => setTimeout(resolve,ms));
            window.onload = function(){
                opa0("#matchName");opa0("#bo");opa0("#blueTeamName");opa0("#orangeTeamName")
                for(let i = 0;i<3;i++){opa0(`#vtuber_b${i+1}`);opa0(`#vtuber_o${i+1}`);}
                fit();
                gsap.delayedCall(1,feed);
            };

            const feed = async() => {
                feedin("#matchName",null,-100);feedin("#bo",null,-100);
                await sleep(1000);
                feedin("#blueTeamName",-100,null);feedin("#orangeTeamName",100,null);
                await sleep(1500);
                feedin("#vtuber_b1",null,300);feedin("#vtuber_o3",null,300);
                await sleep(500);
                feedin("#vtuber_b2",null,300);feedin("#vtuber_o2",null,300);
                await sleep(500);
                feedin("#vtuber_b3",null,300);feedin("#vtuber_o1",null,300);
            }
        </script>
    </body>
</html>